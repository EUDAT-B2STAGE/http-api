
# ################
# ################

# ## RUN THE STACK

# Please use the bash script at the repo root directory:
# ./do help

# ################
# ################


#################################
# Shared volume(s)
sharedvolumes:
    image: alpine
    command: echo "Data volume on"
    volumes:
      - httpapi_sharedcerts:/opt/certificates
      # Sql lite database (only for this container)
      - httpapi_restlitedb:/dbs

#################################
# Postgres database server
sql:
    image: postgres
    volumes:
        - httpapi_sqldata:/var/lib/postgresql/data
    environment:
        POSTGRES_USER: irods
        POSTGRES_PASSWORD: icatserver
        POSTGRES_DB: ICAT

#################################
# iRODS iCAT server for EUDAT B2safe
icat:

  # # Simple irods server
  #image: cineca/icat

  ## OR

  # B2safe instance on irods
  image: eudatb2safe/b2safe

  # # Open irods port to Outside world
  # ## CAREFULL: don't uncomment the two lines below if you don't know why
  # ports:
  #     - 1247:1247

  hostname: rodserver
  volumes:
    - httpapi_etcconf:/etc
    - httpapi_irodshome:/home/irods
    - httpapi_irodsvar:/var/lib/irods
    - httpapi_eudatopt:/opt
    # a script to do operations inside the irods container
    - ./confs/irestart.sh:/irestart
  volumes_from:
    - sharedvolumes
  links:
    - sql:db

#################################
# GRAPHdb neo4j
graphdb:
    image: neo4j:2.3.3
    hostname: gdb
    environment:
      NEO4J_AUTH: neo4j/eudatapi
      # Other parameters?
      #NEO4J_HEAP_MEMORY
      #NEO4J_CACHE_MEMORY
    volumes:
        - httpapi_graphdata:/data

#################################
# iRODS iCAT server for EUDAT B2safe
rest:
  hostname: api
  image: eudatb2safe/apiserver
  command: ./boot
  environment:

    ## MODES
    # APP_MODE: debug
    # APP_MODE: development
    # APP_MODE: production

    # Application credentials to use the b2access environment
    B2ACCESS_APPNAME: httpapi
    B2ACCESS_APPKEY: GIVEMEAVALIDKEY

    # Base the user/role mechanism on neo4j
    BACKEND_AUTH_SERVICE: relationaldb
    ## Connection to irods
    IRODS_ZONE: tempZone
    # IRODS_USER: paolo
    IRODS_USER: rods
    # IRODS_AUTHSCHEME: GSI
    # IRODS_DEFAULT_ADMIN_USER: rodsminer

    ## X509 certificates variables
    #CA Authority
    # X509_CERT_DIR: /opt/certificates/caauth
    # #USER PEMs: Private (key) and Public (Cert)
    # X509_USER_CERT: /opt/certificates/guest/usercert.pem
    # X509_USER_KEY: /opt/certificates/guest/userkey.pem

  working_dir: /code
  volumes:
    # Uploads dir
    - httpapi_tmpuploads:/uploads
    # Base code
    - ./backend:/code
    # Rest API configuration
    - ./vanilla/specs:/code/restapi/confs/endpoints
    # Rest API services models
    - ./vanilla/models:/code/commons/models/custom
    # Rest API endpoints
    - ./vanilla/apis:/code/restapi/resources/custom
    # Tests
    - ./vanilla/tests:/code/test/custom
    # B2ACCESS dev certificates
    - ./certs:/usr/local/share/ca-certificates
    # # Irods home for admin access
    # - httpapi_irodshome:/home/irods

    # # External irods Authority
    # - ./certs/caauth:/opt/certificates/caauth
    # # External irods User
    # - ./certs/user:/opt/certificates/paolo
  volumes_from:
    - sharedvolumes

#################################
# REST API client
# (wget, curl, httpie, http-prompt)

apitests:
  image: eudatb2safe/apiclient
  command: sleep 1234567890
  working_dir: /tmp/client
  volumes:
    - ./vanilla/client:/tmp/client

#################################
# Database administration

# This docker image let you access sqllite/postgres/mysql
# with a phpmyadmin-like web page
sqladmin:
  image: clue/adminer
###########
## TO FIX: should build a custom image here
# otherwise for sqllite admin you are missing a file...
###########
  # links:
  #   - sql:db

#################################
# Nginx proxy
proxy:
  image: nginx
  hostname: myproxy
  volumes:
    # Proxy configuration
    - ./confs/nginx.conf:/etc/nginx/nginx.conf
