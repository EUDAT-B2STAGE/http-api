
# ################
# ################

# ## RUN THE STACK

# Use the script inside the repo.
# From the repo root directory:
# scripts/run.sh help

# ################
# ################


#################################
# Shared volume(s)
certshare:
    image: busybox
    command: echo "Data volume on"
    volumes:
      - httpapi_sharedcerts:/opt/certificates

#################################
# Postgres database server
sql:
    image: postgres
    volumes:
        - httpapi_sqldata:/var/lib/postgresql/data
    environment:
        POSTGRES_USER: irods
        POSTGRES_PASSWORD: icatserver
        POSTGRES_DB: ICAT

#################################
# iRODS iCAT server for EUDAT B2safe
icat:

    # # Simple irods server
    #image: cineca/icat

    ## OR

    # B2safe instance on irods
    image: eudatb2safe/b2safe

    # # Open irods port to Outside world
    # ## CAREFULL: don't uncomment the two lines below if you don't know why
    # ports:
    #     - 1247:1247

    hostname: rodserver
    volumes:
        - httpapi_etcconf:/etc
        - httpapi_irodshome:/home/irods
        - httpapi_irodsvar:/var/lib/irods
        - httpapi_eudatopt:/opt
        # a script to do operations inside the irods container
        - ./confs/irestart.sh:/irestart
    volumes_from:
      - certshare
    links:
        - sql:db

#################################
# GRAPHdb neo4j
graphdb:
    image: neo4j
    hostname: gdb
    environment:
        NEO4J_AUTH: neo4j/eudatapi
      # Other parameters?
      #NEO4J_HEAP_MEMORY
      #NEO4J_CACHE_MEMORY
    volumes:
        - httpapi_graphdata:/data
    ports:
        - 9090:7474

#################################
# iRODS iCAT server for EUDAT B2safe
rest:
    hostname: api
    image: eudatb2safe/apiserver
    command: sleep infinity
    #command: ./boot ##in production?
    environment:
        ## Connection to irods
        IRODS_USER: rods
        # IRODS_AUTHSCHEME: GSI
        # IRODS_USER: paolo
        IRODS_ZONE: tempZone
        ## X509 certificates variables
        #CA Authority
        # X509_CERT_DIR: /opt/certificates/caauth
        # #USER PEMs: Private (key) and Public (Cert)
        # X509_USER_CERT: /opt/certificates/guest/usercert.pem
        # X509_USER_KEY: /opt/certificates/guest/userkey.pem
    ports:
        - 8080:5000
    working_dir: /code/project
    volumes:
        # Uploads
        - httpapi_tmpuploads:/uploads
        # Sql lite database
        - httpapi_restlitedb:/dbs
        # Base code
        - ./backend:/code/project
        # Rest API endpoints
        - ./vanilla/apis:/code/project/restapi/resources/custom
        # Rest API configuration
        - ./vanilla/specs:/code/project/confs/endpoints
        # B2ACCESS dev certificates
        - ./certs:/usr/local/share/ca-certificates
        # # External irods Authority
        # - ./certs/caauth:/opt/certificates/caauth
        # # External irods User
        # - ./certs/user:/opt/certificates/paolo
    volumes_from:
      - certshare
    links:
        # REMOVE GRAPH UNTIL WE REALLY USE IT
        # - graphdb:gdb
        - icat:rodserver

#################################
