#################################
#
# To handle this STACK please use
# $ ./do
#
#################################

# Upgrading to latest docker-compose reference version
# (V3 at the moment) - Feb 2017
version: '3'

#################################
services:

  #############
  # Postgres database server
  sql:
    image: postgres:9.6
    volumes:
      - sqldata:/var/lib/postgresql/data
      - ./builds/postgresql/pgs_init.sh:/docker-entrypoint-initdb.d/setup-my-schema.sh:ro
    environment:
      POSTGRES_USER: "${ALCHEMY_USER}"
      POSTGRES_PASSWORD: "${ALCHEMY_PASSWORD}"
      POSTGRES_DBS: ${ALCHEMY_DBS}
    # healthcheck:
    #   test: ["CMD", "psql", "-U", "${ALCHEMY_USER}", "-c", "\\d"]
    #   interval: 5s
    #   timeout: 3s
    #   retries: 3
    # deploy:
    #   replicas: 1
    networks:
      db_net:
        aliases:
          - ${ALCHEMY_HOST}

  #############
  # iRODS iCAT server for EUDAT B2safe
  icat:
    # B2safe instance on irods
    build: ./builds/b2safe
    image: b2safe:rapydo
    hostname: ${IRODS_HOST}
    # command: sleep infinity

    environment:
      POSTGRES_HOST: "${ALCHEMY_HOST}"
      # port??
      POSTGRES_USER: "${ALCHEMY_USER}"
      POSTGRES_PASSWORD: "${ALCHEMY_PASSWORD}"

      IRODS_HOST: "${IRODS_HOST}"
      IRODS_PORT: ${IRODS_PORT}
      IRODS_ZONE: ${IRODS_ZONE}
      IRODS_DB: "${IRODS_DB}"
      IRODS_USER: ${IRODS_USER}
      # TO FIX: use docker secrets in the future
      IRODS_PASSWORD: ${ALCHEMY_PASSWORD}

    # # Open irods port to Outside world
    # ## CAREFULL: don't uncomment the two lines below if you don't know why
    # ports:
    #     - 1247:1247

    volumes:
      - etcconf:/etc
      - irodshome:/home/irods
      - irodsvar:/var/lib/irods
      - sharedcerts:/opt/certificates
      - ./builds/b2safe/extra_b2safe.sh:/docker-entrypoint.d/b2safe.sh

    networks:
      i_net:
        aliases:
          - ${IRODS_HOST}
      db_net:
    depends_on:
      - sql

  #############
  # GRAPHdb neo4j
  graphdb:
    image: neo4j:3.1.3
    hostname: ${GRAPHDB_HOST}
    environment:
      NEO4J_AUTH: neo4j/${GRAPHDB_PASSWORD}
      # Other parameters?
      #NEO4J_HEAP_MEMORY
      #NEO4J_CACHE_MEMORY
    networks:
      db_net:
        aliases:
          - ${GRAPHDB_HOST}
    volumes:
        - graphdata:/data

  #############
  # iRODS iCAT server for EUDAT B2safe
  rest:
    hostname: api
    build: ./builds/apiserver
    image: apiserver:rapydo
    networks:
      app_net:
        aliases:
          - ${FLASK_HOST}
      db_net:
      i_net:
    # depends_on:
    #   # - graphdb
    #   - icat
    #   - sql

    environment:

      FLASK_APP: run.py
      # base the user/role mechanism on some database
      AUTH_ENABLE: 1
      # putting this here because it should not be configurable in .env
      AUTH_SERVICE: sqlalchemy
      # AUTH_SERVICE: neo4j

      ##############################
      # set this inside the MODE yaml files you want to use
      FLASK_DEBUG: 1
      DEBUG_LEVEL: VERY_VERBOSE
      APP_MODE: debug
      ##############################

      # project/package/prefix name
      VANILLA_PACKAGE: ${COMPOSE_PROJECT_NAME}
      PROJECT_DOMAIN: ${PROJECT_DOMAIN}
      UPLOAD_PATH: ${UPLOAD_PATH}
      JWT_APP_SECRETS: ${JWT_APP_SECRETS}
      # app credentials to work inside the b2access environment
      B2ACCESS_APPNAME: ${B2ACCESS_ACCOUNT}
      B2ACCESS_APPKEY: ${B2ACCESS_SECRET}

      # db access
      ALCHEMY_ENABLE: 1
      ALCHEMY_HOST: ${ALCHEMY_HOST}
      ALCHEMY_PORT: ${ALCHEMY_PORT}
      ALCHEMY_USER: ${ALCHEMY_USER}
      ALCHEMY_PASSWORD: ${ALCHEMY_PASSWORD}
      ALCHEMY_DB: ${ALCHEMY_API_DB}

      # irods configuration
      IRODS_ENABLE: 1
      IRODS_HOST: ${IRODS_HOST}
      IRODS_PORT: ${IRODS_PORT}
      IRODS_USER: ${IRODS_USER}
      IRODS_ZONE: ${IRODS_ZONE}
      IRODS_HOME: ${IRODS_HOME}
      IRODS_DN: ${IRODS_DN}
      IRODS_PASSWORD: ${ALCHEMY_PASSWORD}
      IRODS_AUTHSCHEME: ${IRODS_AUTHSCHEME}
      IRODS_GUEST_USER: ${IRODS_GUEST_USER}
      IRODS_DEFAULT_ADMIN_USER: ${IRODS_DEFAULT_ADMIN_USER}

      # # neo connection
      # GRAPHDB_ENABLE: 0
      # # GRAPHDB_ENABLE: 1
      # GRAPHDB_HOST: ${GRAPHDB_HOST}
      # GRAPHDB_PORT: ${GRAPHDB_BOLT_PORT}
      # GRAPHDB_PASSWORD: ${GRAPHDB_PASSWORD}

      HANDLE_CREDENTIALS: ${HANDLE_CREDENTIALS}

    volumes:
      # Base code
      - ./backend:/code
      # Vanilla code
      - ./vanilla:/code/${COMPOSE_PROJECT_NAME}
      # Tests
      - ./vanilla/tests:/code/test/custom
      # Uploads dir
      - tmpuploads:${UPLOAD_PATH}
      # JWT tokens secret
      - jwttokens:/${JWT_APP_SECRETS}
      # SHARED
      - sharedcerts:/opt/certificates
      # B2ACCESS dev certificates
      - ./certs:/usr/local/share/ca-certificates
      # # mount irods code to develop patches
      # - ./prc/irods:/usr/local/lib/python3.6/dist-packages/irods

  #############
  # Nginx proxy
  proxy:
    build: ./builds/sslproxy
    image: nginx:rapydo
    hostname: reverseproxy
    networks:
      proxy_net:
        aliases:
          - ${PROXY_HOST}
      app_net:
    depends_on:
      - rest

  #############
  # REST API client (wget, curl, httpie, http-prompt)
  client:
    build: ./builds/apiclient
    image: apiclient:rapydo
    environment:
      MAIN_ENDPOINT: ${API_MAIN_ENDPOINT}
      IRODS_ZONE: ${IRODS_ZONE}
      IRODS_GUEST_USER: ${IRODS_GUEST_USER}
    volumes:
      - ./backend:/code/core
      - ./vanilla:/code/custom

  #############
  # Database administration
  sqladmin:
    build: ./builds/sqladmin
    image: sqladminer:rapydo
    networks:
      db_net:

  #############
  # Client interface if using swagger
  swagclient:
    build: ./builds/swaggerui
    image: swagger-ui:rapydo
    # Note: no network is required since localhost is already opened

#################################
volumes:
  sharedcerts:
    driver: local
  sqldata:
    driver: local
  etcconf:
    driver: local
  irodshome:
    driver: local
  irodsvar:
    driver: local
  tmpuploads:
    driver: local
  jwttokens:
    driver: local
  graphdata:
    driver: local
  sslcerts:
    driver: local

networks:
  # default:
  i_net:
  app_net:
  proxy_net:
  db_net:
    # driver: bridge
    ipam:
      driver: default
      config:
        # Note: use this configuration to match inside internal rules
        # TO FIX: make this an env variable
        - subnet: ${DB_SUBNET}/16
